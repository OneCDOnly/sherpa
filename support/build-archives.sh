#!/usr/bin/env bash

# compiler for all sherpa archives

echo -n 'building archives ... '

WORK_PATH=$PWD/..

MANAGER_FILE=sherpa.manager.sh
MANAGER_ARCHIVE_FILE=${MANAGER_FILE%.*}.tar.gz
MANAGER_ARCHIVE_PATHFILE=$WORK_PATH/$MANAGER_ARCHIVE_FILE

OBJECTS_FILE=objects
OBJECTS_ARCHIVE_FILE=$OBJECTS_FILE.tar.gz
OBJECTS_ARCHIVE_PATHFILE=$WORK_PATH/$OBJECTS_ARCHIVE_FILE
OBJECTS_PATHFILE=$WORK_PATH/$OBJECTS_FILE

PACKAGES_FILE=packages
PACKAGES_ARCHIVE_FILE=$PACKAGES_FILE.tar.gz
PACKAGES_ARCHIVE_PATHFILE=$WORK_PATH/$PACKAGES_ARCHIVE_FILE

[[ -e $MANAGER_ARCHIVE_PATHFILE ]] && chmod 666 "$MANAGER_ARCHIVE_PATHFILE"
[[ -e $OBJECTS_ARCHIVE_PATHFILE ]] && chmod 666 "$OBJECTS_ARCHIVE_PATHFILE"
[[ -e $PACKAGES_ARCHIVE_PATHFILE ]] && chmod 666 "$PACKAGES_ARCHIVE_PATHFILE"

[[ -e $MANAGER_ARCHIVE_PATHFILE ]] && rm $MANAGER_ARCHIVE_PATHFILE
[[ -e $OBJECTS_ARCHIVE_PATHFILE ]] && rm $OBJECTS_ARCHIVE_PATHFILE
[[ -e $PACKAGES_ARCHIVE_PATHFILE ]] && rm $PACKAGES_ARCHIVE_PATHFILE

tar --create --gzip --numeric-owner --file="$MANAGER_ARCHIVE_PATHFILE" --directory="$WORK_PATH" "$MANAGER_FILE"
tar --create --gzip --numeric-owner --file="$OBJECTS_ARCHIVE_PATHFILE" --directory="$WORK_PATH" "$OBJECTS_FILE"
tar --create --gzip --numeric-owner --file="$PACKAGES_ARCHIVE_PATHFILE" --directory="$WORK_PATH" "$PACKAGES_FILE"

chmod 444 "$MANAGER_ARCHIVE_PATHFILE"
chmod 444 "$OBJECTS_ARCHIVE_PATHFILE"
chmod 444 "$PACKAGES_ARCHIVE_PATHFILE"

echo 'done!'
exit 0
