#!/usr/bin/env bash

echo -n 'building management script ... '

working_path=$HOME/scripts/nas/sherpa/support

source_pathfile=$working_path/sherpa.manager.source
target_pathfile=$working_path/sherpa.manager.sh

dontedit_msg=" do not edit this file - it should only be built with the '$(basename "$0")' script"
branch=$(<"$working_path"/branch.txt)
buffer=$(<"$source_pathfile")

buffer=$(sed "s|<?dontedit?>|$dontedit_msg|" <<< "$buffer")
buffer=$(sed "s|<?year?>|$(date '+%Y')|" <<< "$buffer")
buffer=$(sed "s|<?today?>|$(date '+%y%m%d')|" <<< "$buffer")
buffer=$(sed "s|<?branch?>|$branch|" <<< "$buffer")
buffer=$(sed "/^$/d" <<< "$buffer")                                                     # remove empty lines
buffer=$(sed -e '/^[[:space:]]*# /d;s/[[:space:]]#[[:space:]].*//' <<< "$buffer")       # remove comment lines and line comments
buffer=$(sed -e 's/^[[:space:]]*//' <<< "$buffer")                                      # remove leading whitespace
buffer=$(sed "s|Content-Transfer-Encoding: base64|Content-Transfer-Encoding: base64\n|" <<< "$buffer")	# need to add a newline after this string so signature block is accepted by QTS

[[ -e $target_pathfile ]] && rm -f "$target_pathfile"
echo "$buffer" > "$target_pathfile"
chmod 554 "$target_pathfile"

echo 'done'
exit 0
